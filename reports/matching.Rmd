---
title: "Lung Cancer and MMA matching"
author: "Rachel Heise, MS"
pi: "Yiwey Shieh, MD"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  wcmtheme::wcm_html: 
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(MatchIt)
library(readxl)
library(tidyverse)
library(gtsummary)

load("/Volumes/Shieh-share$/MMA_Cancer/output/all_cases_controls.RData")
load(here::here("./output/NHANES_dat.RData"))
```


## 1:3 Optimal Matching using the MatchIt package


```{r}
# 1:3 optimal matching using MatchIt package
m_out3 <- matchit(cancer ~ age + B12 + CREATININE, 
                  data = all_cases_controls, method = "optimal", ratio = 3)

summary(m_out3)

matched_data_3 <- match.data(m_out3)

```

### Assess the quality of matches

```{r}
plot(m_out3, type = "jitter", interactive = FALSE)

plot(m_out3, type = "density", interactive = FALSE,
     which.xs = ~age + B12 + CREATININE)

plot(summary(m_out3), xlim = c(0,3.6))
```

### Assess NHANES year of matches

```{r}
nhanes_dat %>% 
  filter(SEQN %in% matched_data_3$SEQN) %>% 
  select(year) %>% 
  tbl_summary() %>% 
  bold_labels()
```

## 1:4 Optimal Matching using the MatchIt package


```{r}
# 1:4 optimal matching using MatchIt package
m_out4 <- matchit(cancer ~ age + B12 + CREATININE, 
                  data = all_cases_controls, method = "optimal", ratio = 4)

summary(m_out4)

matched_data_4 <- match.data(m_out4)
```

### Assess the quality of matches

```{r}
plot(m_out4, type = "jitter", interactive = FALSE)

plot(m_out4, type = "density", interactive = FALSE,
     which.xs = ~age + B12 + CREATININE)

plot(summary(m_out4), xlim = c(0,3.6))
```

### Assess NHANES year of matches

```{r}
nhanes_dat %>% 
  filter(SEQN %in% matched_data_4$SEQN) %>% 
  select(year) %>% 
  tbl_summary() %>% 
  bold_labels()
```


## 1:3 Propensity Score Matching using the MatchIt package


```{r}
# 1:3 optimal matching using MatchIt package
m_out_prop <- matchit(cancer ~ age + B12 + CREATININE, 
                      data = all_cases_controls, method = "nearest", ratio = 3)

summary(m_out_prop)

matched_data_prop <- match.data(m_out_prop)
```

### Assess the quality of matches

```{r}
plot(m_out_prop, type = "jitter", interactive = FALSE)

plot(m_out_prop, type = "density", interactive = FALSE,
     which.xs = ~age + B12 + CREATININE)

plot(summary(m_out_prop), xlim = c(0,3.6))
```


```{r, eval=FALSE}
# data for power calculation

# calculate standard deviation of MMA
sd(matched_data_3$MMA)

# calculate R^2 by regressing other covariates on MMA
mod <- glm(MMA ~ age + B12 + CREATININE, data = matched_data_3)

residuals <- residuals(mod)
SSM <- sum((fitted(mod) - mean(matched_data_3$MMA))^2)
SST <- sum((matched_data_3$MMA - mean(matched_data_3$MMA))^2)
r_squared <- 1 - (sum(residuals^2) / SST)
r_squared
```

```{r, eval=FALSE}
# save 1:3 matched data

save(matched_data_3, file = "/Volumes/Shieh-share$/MMA_Cancer/output/matched_data_3.RData")
save(matched_data_4, file = "/Volumes/Shieh-share$/MMA_Cancer/output/matched_data_4.RData")
```


