---
title: "Lung Cancer and MMA matching"
author: "Rachel Heise, MS"
pi: "Yiwey Shieh, MD"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  wcmtheme::wcm_html: 
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(MatchIt)
library(readxl)
library(tidyverse)
library(gtsummary)

load(here::here("./output/NHANES_dat.RData"))
load(here::here("./output/cancer_pts.RData"))

# change NHANES data format to match lung cancer data format
nhanes_matching <- nhanes_dat %>% 
  mutate(MMA = MMA/1000) %>% # convert nmol/L to umol/L
  filter(cancer_malignancy == "No", # remove any NHANES participants with a history of cancer
         !is.na(B12), # remove participants missing B12 or Creatinine data
         !is.na(CREATININE)) %>% 
  select(SEQN, age, MMA, B12, CREATININE) %>% 
  mutate(cancer = 0)

# combine nhanes with lung cancer data
data <- rbind(cancer_pts, nhanes_matching)

```


## 1:3 Optimal Matching using the MatchIt package


```{r}
# 1:3 optimal matching using MatchIt package
m.out <- matchit(cancer ~ age + B12 + CREATININE, 
                 data = data, method = "optimal", ratio = 3)

summary(m.out)

matched_data <- match.data(m.out)
```

### Assess the quality of matches

```{r}
plot(m.out, type = "jitter", interactive = FALSE)

plot(m.out, type = "density", interactive = FALSE,
     which.xs = ~age + B12 + CREATININE)

plot(summary(m.out), xlim = c(0,3.6))
```

### Assess NHANES year of matches

```{r}
nhanes_dat %>% 
  filter(SEQN %in% matched_data$SEQN) %>% 
  select(year) %>% 
  tbl_summary() %>% 
  bold_labels()
```


## 1:3 Propensity Score Matching using the MatchIt package


```{r}
# 1:3 optimal matching using MatchIt package
m.out2 <- matchit(cancer ~ age + B12 + CREATININE, 
                  data = data, method = "nearest", ratio = 3)

summary(m.out2)

matched_data2 <- match.data(m.out2)
```

### Assess the quality of matches

```{r}
plot(m.out2, type = "jitter", interactive = FALSE)

plot(m.out2, type = "density", interactive = FALSE,
     which.xs = ~age + B12 + CREATININE)

plot(summary(m.out2), xlim = c(0,3.6))
```

